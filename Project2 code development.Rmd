```{r}
library(tidyverse)
library(readr)
library(ggplot2)
library(dplyr)
library(scales)

```

```{r Type 1 of 6 Agency Code Key}

agency_key_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/awards/count")

agency_key_parsed <- jsonlite::fromJSON(rawToChar(agency_key_raw$content))

agency_key_df <- as_tibble(agency_key_parsed$results[[1]]) |>
  rename("agency_name" = awarding_toptier_agency_name,
         "agency_code" = awarding_toptier_agency_code)

agency_key_df$agency_code <- as.numeric(agency_key_df$agency_code)

agency_key <- agency_key_df

agency_key

agency_key_plot <- ggplot(agency_key, aes(x = agency_name, y = contracts, fill = agency_name))

agency_key_plot +
  geom_col() +
  scale_fill_discrete(name = "Agency") +
  theme(axis.text.x = element_blank()) +  
  labs(x = "Agency", y = "# of Awards Granted") +
  coord_cartesian(ylim = c(0, 2000000))
  

```


```{r Data type 2 of 6 Agency Budget and Obligations}

agency_budget_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/012/budgetary_resources/")

agency_budget_parsed <- jsonlite::fromJSON(rawToChar(agency_budget_raw$content))

agency_budget_df <- as_tibble(agency_budget_parsed$agency_data_by_year) |>
  select(fiscal_year:total_budgetary_resources) |>
  rename("agency_budget" = agency_budgetary_resources,
         "agency_obligations" = agency_total_obligated) |>
  mutate("agency_code" = 12, .before = fiscal_year)

agency_budget <- agency_key |>
  select(agency_name, agency_code) |>
  right_join(agency_budget_df, join_by(agency_code)) 

             
agency_budget 

agency_budget_plot <- ggplot(agency_budget, aes(x = fiscal_year, y = agency_budget))

agency_budget_plot +
  geom_line(aes(y = agency_budget, color = "Budget")) +
  geom_line(aes(y = agency_obligations, color = "Obligations")) +
  scale_y_continuous(labels=comma) +
  scale_color_manual("$ Amount Type", 
                     breaks = c("Budget", "Obligations"), 
                     values = c("blue", "red")) +
  labs(title = "Agency Budget", x = "Budget Year", y = "$ Amount") 

```


```{r data type 3 of 6 Agency Obligations}

agency_account_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/012/federal_account/")

agency_account_parsed <- jsonlite::fromJSON(rawToChar(agency_account_raw$content))

agency_account_df <- as_tibble(agency_account_parsed$results) |>
  select(code, name, obligated_amount, gross_outlay_amount) |>
  mutate("agency_code" = 12, .before = code)

agency_account <- agency_key |>
  select(agency_name, agency_code) |>
  right_join(agency_account_df, join_by(agency_code))

agency_account

agency_account_plot <- ggplot(agency_account, aes(code, obligated_amount, fill = code))

agency_account_plot +
  geom_col() +
  scale_y_continuous(label = comma)+
  theme(axis.text.x = element_blank()) +
  scale_fill_discrete(name = "Program Code")+
  labs(x = "Program Code", y = "$ Amount")

```


```{r Data type 4 of 6 Agency Obligation Class}

agency_object_class_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/012/object_class")

agency_object_class_parsed <- jsonlite::fromJSON(rawToChar(agency_object_class_raw$content))

agency_object_class_df <- as_tibble(agency_object_class_parsed$results) |>
  rename("obligation_name" = name) |>
  mutate("agency_code" = 12, .before = obligation_name)

agency_object <- agency_key |>
  select(agency_name, agency_code) |>
  right_join(agency_object_class_df, join_by(agency_code))

agency_object



agency_object_plot <- ggplot(agency_object, aes(obligation_name, obligated_amount, color = obligation_name))

agency_object_plot +
  geom_point(aes(gross_outlay_amount, shape = "Object")) +
  geom_point(aes(obligated_amount, shape = "Obligated")) +
  scale_y_continuous(labels=comma) +
  scale_color_discrete(name = "Obligation Type") +
  scale_shape_discrete(name = "Shape") +
  theme(axis.text.x = element_blank()) +
  labs(x = "Obligation", y = "$ Amount Spent") +
  coord_cartesian(ylim = c(0,110000000000))


```


```{r Data type 5 of 6 Agency Award Types}


agency_obligations_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/012/obligations_by_award_category")

agency_obligations_parsed <- jsonlite::fromJSON(rawToChar(agency_obligations_raw$content))

agency_obligations_df <- as_tibble(agency_obligations_parsed$results) |>
  mutate("agency_code" = 12, .before = category)  


agency_obligations <- agency_key |>
  select(agency_name, agency_code) |>
  right_join(agency_obligations_df, join_by(agency_code))

agency_obligations

agency_obligations_plot <- ggplot(data = agency_obligations, aes(x = category, y = aggregated_amount, fill = category))

agency_obligations_plot +
  geom_col() +
  scale_y_continuous(labels = comma)+
  scale_fill_discrete(name = "Obligation Award Type")+
  theme(axis.text.x = element_blank())


```


```{r Data type 6 of 6 Agency Activities}

agency_activities_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/012/program_activity/")

agency_activities_parsed <- jsonlite::fromJSON(rawToChar(agency_activities_raw$content))

agency_activities_df <- as_tibble(agency_activities_parsed$results) |>
  mutate("agency_code" = 12, .before = name)

agency_activities <- agency_key |>
  select(agency_name, agency_code) |>
  right_join(agency_activities_df, join_by(agency_code))

agency_activities

agency_activities_plot <- ggplot(data = agency_activities, aes(x = name, y = gross_outlay_amount))

agency_activities_plot +
  geom_point(aes(gross_outlay_amount, color = "Budgeted")) +
  geom_point(aes(obligated_amount, color = "Obligated")) +
  scale_y_continuous(labels = comma)+
  scale_fill_discrete(name = "Program Activity")+
  labs(x = "Program Activity", y = "$ Amount Spent") +
  theme(axis.text.x = element_blank())+
  theme(strip.text = element_text(size = 6)) +
  scale_color_manual("", 
                   breaks = c("Budgeted", "Obligated"), 
                   values = c("blue", "red")) +
  facet_wrap(~name, labeller = labeller(name = label_wrap_gen(width = 15)))

```

```{r Data page code to generate inital data table and plot}
#  The first thing we're going to do is generate the key that ties
#  the agencies with the code that is used throughout the remaining
#  API endpoints. 
#  
#  The agency key also has a data table associated with it that we will 
#  use as a static display to drive the interest of the user to 
#  further investigate the separate departments.
#   
  
  agency_key_raw <- httr::GET("https://api.usaspending.gov/api/v2/agency/awards/count")

  agency_key_parsed <- jsonlite::fromJSON(rawToChar(agency_key_raw$content))

  agency_key_df <- as_tibble(agency_key_parsed$results[[1]]) |>
    rename("agency_name" = awarding_toptier_agency_name,
           "agency_code" = awarding_toptier_agency_code,
           "indef_deliv_contract" = idvs) |>
    mutate(total_awards = contracts + direct_payments + grants + indef_deliv_contract + loans + other) |>
    arrange(desc(total_awards))
  

  agency_key_df$agency_code <- as.numeric(agency_key_df$agency_code)

  agency_key <- agency_key_df

  agency_key
  
  agency_key_plot <- ggplot(agency_key, aes(x = agency_name, y = total_awards, fill = agency_name))

agency_key_plot +
  geom_col() +
  scale_fill_discrete(name = "Agency") +
  theme(axis.text.x = element_blank()) +  
  labs(x = "Agency", y = "# of Awards Granted")
  
  
```


```{r Write the function to que agency and endpoints}



govt_spending <-function(agency_name, report) {
  
#  First, we need to convert our agency name into it's associated code
#  for use in pulling the differing data sets at the endpoints. 
  
  if(agency_name %in% "Department of Defense") {
    agency_code = "097"
  } else if(agency_name %in% "Department of Agriculture") {
    agency_code = "012"
  } else if(agency_name %in% "General Services Administration") {
    agency_code = "047"
  } else if(agency_name %in% "Department of Housing and Urban Development") {
    agency_code = "086"
  } else if(agency_name %in% "Department of Veterans Affairs") {
    agency_code = "036"
  } else if(agency_name %in% "Social Security Administration") {
    agency_code = "028"
  } else if(agency_name %in% "Department of Health and Human Services") {
    agency_code = "075"
  } else if(agency_name %in% "Federal Communications Commission") {
    agency_code = "027"
  } else if(agency_name %in% "Small Business Administration") {
    agency_code = "073"
  } else if(agency_name %in% "Railroad Retirement Board") {
    agency_code = "060"
  } else if(agency_name %in% "All") {
    print ("Error: This selection is not currently available")
  }
  
  
  
#  Next we will generate conditional logic statements to determine the
#  endpoint information that will be generated. 
  
    if(report %in% "Budgetary Resources") {
    endpoint <- c("budgetary_resources")
    } else if(report %in% "Federal Account") {
      endpoint <- c("federal_account")
    } else if(report %in% "Obligation Type") {
      endpoint <- c("object_class")
    } else if(report %in% "Award Obligations") {
      endpoint <- c("obligations_by_award_category")
    } else if(report %in% "Program Activity") {
      endpoint <- c("program_activity")
    } 
  
  
  
#  Now that we have the conditional logic statements generated, we
#  will use them to generate the API URLs and parse the API data 
#  we are going to use to generate our data tables and graphics.
  
  url_raw_data <- httr::GET(str_c("https://api.usaspending.gov/api/v2/agency/",agency_code, "/", endpoint, "/"))
  
  url_parsed <- jsonlite::fromJSON(rawToChar(url_raw_data$content))
  
  
  
#  Because each endpoint has different variables associated with it,
#  we will be using more conditional logic to extract usable data and
#  generate our summary graphics.
#  
#  Each data set had the agency code added to it for merging with the
#  agency name. This is necessary for the `full_join` that will be 
#  used to compare the different agencies with one another on the
#  `Data Exploration` tab of the app. 
#
#  There are 6 endpoints in all that will be analyzed. We will be 
#  using a `right_join` for each data set to merge the 

  
#  The first data table we're going to read in is
  if(endpoint %in% "budgetary_resources") {
    df <- as_tibble(url_parsed$agency_data_by_year) |>
      select(fiscal_year:total_budgetary_resources) |>
      rename("agency_budget" = agency_budgetary_resources,
             "agency_obligations" = agency_total_obligated) |>
      mutate("agency_code" = agency_code, .before = 1)
  
    df$agency_code <- as.numeric(df$agency_code)
  
    endpoint_df <- agency_key |>
    select(agency_name, agency_code) |>
    right_join(df, join_by(agency_code))  
  
    print(endpoint_df)
    
    endpoint_df_plot <- ggplot(endpoint_df, aes(x = fiscal_year, y = agency_budget))

    endpoint_df_plot +
      geom_line(aes(y = agency_budget, color = "Budget")) +
      geom_line(aes(y = agency_obligations, color = "Obligations")) +
      scale_y_continuous(labels=comma) +
      scale_color_manual("$ Amount Type", 
                         breaks = c("Budget", "Obligations"), 
                     values = c("blue", "red")) +
      labs(title = "Agency Budget", x = "Budget Year", y = "$ Amount") 
    
    
  } else if(endpoint %in% "federal_account") {
      df <- as_tibble(url_parsed$results) |>
        select(code, name, obligated_amount, gross_outlay_amount) |>
        mutate("agency_code" = agency_code, .before = 1)
      
      df$agency_code <- as.numeric(df$agency_code)

      endpoint_df <- agency_key |>
        select(agency_name, agency_code) |>
        right_join(df, join_by(agency_code))  
  
      print(endpoint_df)
      
      endpoint_df_plot <- ggplot(endpoint_df, aes(code, obligated_amount, fill = code))

      endpoint_df_plot +
        geom_col() +
        scale_y_continuous(label = comma)+
        theme(axis.text.x = element_blank()) +
        scale_fill_discrete(name = "Program Code")+
        labs(x = "Program Code", y = "$ Amount")
      
  } else if(endpoint %in% "object_class") {
      df <- as_tibble(url_parsed$results) |>
        rename("obligation_name" = name) |>
        mutate("agency_code" = agency_code, .before = 1)
      
        df$agency_code <- as.numeric(df$agency_code)


      endpoint_df <- agency_key |>
        select(agency_name, agency_code) |>
        right_join(df, join_by(agency_code))  
  
      print(endpoint_df)
      
      
      endpoint_df_plot <- ggplot(endpoint_df, aes(obligation_name, obligated_amount, color = obligation_name))

      endpoint_df_plot +
        geom_point(aes(gross_outlay_amount, shape = "Object")) +
        geom_point(aes(obligated_amount, shape = "Obligated")) +
        scale_x_continuous() +
        scale_y_continuous(labels=comma) +
        scale_color_discrete(name = "Obligation Type") +
        scale_shape_discrete(name = "Shape") +
        theme(axis.text.x = element_blank()) +
        labs(x = "Obligation", y = "$ Amount Spent") +
        coord_cartesian(ylim = c(0,120000000000))
      
  } else if(endpoint %in% "obligations_by_award_category") {
      df <- as_tibble(url_parsed$results) |>
        mutate("agency_code" = agency_code, .before = 1)  
      
      df$agency_code <- as.numeric(df$agency_code)      

      endpoint_df <- agency_key |>
        select(agency_name, agency_code) |>
        right_join(df, join_by(agency_code))  
  
      print(endpoint_df)
      
      endpoint_df_plot <- ggplot(data = endpoint_df, aes(x = category, y = aggregated_amount, fill = category))

      endpoint_df_plot +
        geom_col() +
        scale_y_continuous(labels = comma)+
        scale_fill_discrete(name = "Obligation Award Type")+
        theme(axis.text.x = element_blank()) +
        coord_cartesian(ylim = c(0,120000000000))
      
  } else if(endpoint %in% "program_activity") {
      no_na <- c("Undisclosed") 
      
      df <- as_tibble(url_parsed$results) |>
        mutate("agency_code" = agency_code, .before = 1) |>
        mutate(name = str_replace(name, "N/A", "UNDISCLOSED"))        

      df$agency_code <- as.numeric(df$agency_code)      

      
      
      endpoint_df <- agency_key |>
        select(agency_name, agency_code) |>
        right_join(df, join_by(agency_code))  
  
      print(endpoint_df)
      
      endpoint_df_plot <- ggplot(data = endpoint_df, aes(x = name, y = gross_outlay_amount))

      endpoint_df_plot +
        geom_point(aes(gross_outlay_amount, color = "Budgeted")) +
        geom_point(aes(obligated_amount, color = "Obligated")) +
        scale_y_continuous(labels = comma)+
        scale_fill_discrete(name = "Program Activity")+
        labs(x = "Program Activity", y = "$ Amount Spent") +
        theme(axis.text.x = element_blank())+
        theme(strip.text = element_text(size = 6)) +
        scale_color_manual("", 
                         breaks = c("Budgeted", "Obligated"), 
                         values = c("blue", "red")) +
        facet_wrap(~name, labeller = labeller(name = label_wrap_gen(width = 15)))
      
  } 
  
  }
  

#test the function

govt_spending("Social Security Administration", "Program Activity")

```

```{r Genrate code for the ALL selection}



```



  



